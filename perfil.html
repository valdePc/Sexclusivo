<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil de Clon</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .profile-header {
      position: relative;
      text-align: center;
      padding: 20px;
      background: rgba(255, 0, 127, 0.1);
      border-bottom: 2px solid #ff007f;
      box-shadow: 0px 4px 10px rgba(255, 0, 127, 0.3);
    }
    .cover-photo {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .profile-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid #ff007f;
      margin-top: -60px;
    }
    .gallery {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      padding: 20px;
    }
    .gallery img, .gallery video {
      width: 120px;
      height: 120px;
      border-radius: 10px;
      box-shadow: 0px 4px 10px rgba(255, 0, 127, 0.3);
    }
    .chat-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ff007f;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
    }
    .chat-container {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: #222;
      padding: 15px;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
      font-family: Arial, sans-serif;
    }
    .chat-box {
      height: 250px;
      overflow-y: auto;
      background: #333;
      padding: 10px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
    }
    .chat-message {
      max-width: 80%;
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 10px;
      font-size: 14px;
      position: relative;
      animation-duration: 0.5s;
      animation-fill-mode: both;
    }
    .user-message {
      align-self: flex-end;
      background: #ff007f;
      text-align: right;
      animation-name: slideInRight;
    }
    .bot-message {
      align-self: flex-start;
      background: #444;
      text-align: left;
      animation-name: slideInLeft;
    }
    @keyframes slideInRight {
      0% { opacity: 0; transform: translateX(50px); }
      100% { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInLeft {
      0% { opacity: 0; transform: translateX(-50px); }
      100% { opacity: 1; transform: translateX(0); }
    }
    .typing-indicator {
      font-size: 12px;
      color: lightgray;
      font-style: italic;
      margin-top: 5px;
    }
    .chat-input-container {
      display: flex;
      align-items: center;
    }
    .chat-input {
      width: 80%;
      padding: 10px;
      border: none;
      border-radius: 5px;
    }
    .send-btn {
      width: 18%;
      padding: 10px;
      margin-left: 5px;
      background: #e60073;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #followButton {
      background: linear-gradient(45deg, #ff007f, #e60073);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0px 4px 10px rgba(255, 0, 127, 0.5);
      margin-top: 10px;
    }
    #followButton:hover {
      background: linear-gradient(45deg, #e60073, #ff007f);
      transform: scale(1.05);
    }
    #backButton {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(45deg, #ff007f, #e60073);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0px 4px 10px rgba(255, 0, 127, 0.5);
    }
    #backButton:hover {
      background: linear-gradient(45deg, #e60073, #ff007f);
      transform: scale(1.05);
    }
    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,0,127,0.2) 0%, rgba(0,0,0,0.9) 100%);
      overflow: hidden;
      z-index: -1;
    }
    .particle {
      position: absolute;
      width: 5px;
      height: 5px;
      background: #ff007f;
      border-radius: 50%;
      opacity: 0.7;
      animation: float 5s infinite linear;
    }
    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); }
      100% { transform: translateY(-100vh) rotate(360deg); }
    }
    /* Animaciones para mensajes */
    .chat-message {
      max-width: 80%;
      padding: 10px;
      border-radius: 10px;
      font-size: 14px;
      position: relative;
      animation-duration: 0.5s;
      animation-fill-mode: both;
    }
    .user-message {
      align-self: flex-end;
      background: #ff007f;
      text-align: right;
      animation-name: slideInRight;
    }
    .bot-message {
      align-self: flex-start;
      background: #444;
      text-align: left;
      animation-name: slideInLeft;
    }
    @keyframes slideInRight {
      0% { opacity: 0; transform: translateX(50px); }
      100% { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInLeft {
      0% { opacity: 0; transform: translateX(-50px); }
      100% { opacity: 1; transform: translateX(0); }
    }
    #rejectCallButton {
      background: #cc0000;
      color: white;
    }
    
  </style>
</head>
<body>
  
  <script src="https://js.stripe.com/v3/"></script>
  <!-- <script src="https://www.paypal.com/sdk/js?client-id=TU_PAYPAL_CLIENT_ID"></script> -->
  <div class="background"></div>
  <div class="profile-header">
    <img id="coverPhoto" class="cover-photo" src="" alt="Portada">
    <img id="profilePhoto" class="profile-photo" src="" alt="Foto de perfil">
    <h2 id="cloneName"></h2>
    <p id="cloneDescription"></p>
  </div>
  <button id="followButton" onclick="showPaymentOptions()">Seguir</button>
  <div id="paymentOptions" style="display: none;">
    <button onclick="handleStripePayment()">Pagar con Stripe</button>
    <div id="paypal-button-container"></div>
  </div>
  <h3>GalerÃ­a de <span id="galleryTitle"></span></h3>
  <div class="gallery" id="gallery"></div>
  <button class="chat-button" onclick="toggleChat()">ðŸ’¬</button>
  <!-- Contenedor del chat con botÃ³n de llamada -->
  <div class="chat-container" id="chatContainer">
    <!-- BotÃ³n de llamada -->
    <button id="phoneCallButton" onclick="goToCall()" title="Iniciar llamada" style="position: absolute; top: 0; right: 0; background: transparent; border: none; font-size: 32px; cursor: pointer;">ðŸ“ž</button>
    <h3>Chat con <span id="chatCloneName"></span></h3>
    <div class="chat-box" id="chatBox"></div>
    <div id="typingIndicator" class="typing-indicator" style="display: none;"></div>
    <div class="chat-input-container">
      <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="sendPhotoMessage(event)">
      <button onclick="document.getElementById('photoInput').click()">ðŸ“·</button>
      <input type="text" id="chatInput" class="chat-input" placeholder="Escribe un mensaje..." oninput="showTypingStatus()">
      <button class="send-btn" onclick="sendMessage()">Enviar</button>
    </div>
    <button id="backButton" onclick="goBack()">â†© Volver</button>
    <script>
      // URL base para TTS y demÃ¡s endpoints
      const BASE_TTS_URL = "https://sexclusivo-production.up.railway.app";
      
      // Obtener parÃ¡metros de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const cloneId = urlParams.get('id');
      const apiKey = "patyZBvcOIap41ai5.d05bb4c1056c366b3daa016ff81d704f0d16b8bc2883e1d55036efea92366a5f";
      const airtableBaseId = "app4hvr9H3C5RzRLh";
      const geminiApiKey = "AIzaSyDQnmskTmDXtPtm7ACjOkZLlf2WGAQJjN4";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;
      const airtableUrl = `https://api.airtable.com/v0/${airtableBaseId}/Clones/${cloneId}`;
      
      // FunciÃ³n simulada de pago (ajÃºstala segÃºn necesites)
      async function processPayment(cardNumber, expiryDate, cvv) {
        return { success: true };
      }
      
      async function handleFollow() {
        const userId = prompt("Ingrese su ID de usuario para seguir a este clon:");
        if (!userId) return alert("Debe ingresar un ID de usuario.");
      
        const confirmPayment = confirm("Para seguir a este clon, debe agregar una tarjeta y realizar un pago. Â¿Desea contifnuar?");
        if (!confirmPayment) return;
      
        const cardNumber = prompt("Ingrese su nÃºmero de tarjeta:");
        const expiryDate = prompt("Ingrese la fecha de vencimiento (MM/AA):");
        const cvv = prompt("Ingrese el cÃ³digo de seguridad (CVV):");
      
        if (!cardNumber || !expiryDate || !cvv) return alert("Debe ingresar todos los datos de la tarjeta.");
      
        try {
          const paymentResponse = await processPayment(cardNumber, expiryDate, cvv);
          if (!paymentResponse.success) throw new Error("Pago rechazado");
      
          const followData = {
            fields: {
              UsuarioID: userId,
              ClonID: cloneId,
              Fecha: new Date().toISOString(),
            }
          };
      
          const response = await fetch(`https://api.airtable.com/v0/${airtableBaseId}/Seguidores`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${apiKey}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(followData)
          });
      
          if (!response.ok) throw new Error("Error al guardar en Airtable");
      
          alert("Ahora sigues a este clon.");
        } catch (error) {
          alert("Error: " + error.message);
        }
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        window.speechSynthesis.onvoiceschanged = () => {
          const voices = window.speechSynthesis.getVoices();
          console.log("Voces cargadas:", voices);
        };
        fetchCloneData();
      });
      
      function goToCall() {
  window.open("llamada.html?id=" + cloneId, "_blank", "width=800,height=600");
}

      function createParticles() {
        const background = document.querySelector('.background');
        background.innerHTML = "";
        for (let i = 0; i < 30; i++) {
          let particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * 100 + 'vw';
          particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
          background.appendChild(particle);
        }
      }
      createParticles();
      
      async function fetchCloneData() {
        try {
          const response = await fetch(airtableUrl, {
            headers: { "Authorization": `Bearer ${apiKey}` }
          });
          if (!response.ok) throw new Error("Error al obtener datos del clon");
          const data = await response.json();
          displayCloneData(data.fields);
        } catch (error) {
          alert("Error al cargar el perfil del clon.");
        }
      }
      function displayCloneData(fields) {
  document.getElementById("coverPhoto").src = (fields.Portada && fields.Portada[0]) ? fields.Portada[0].url : "https://via.placeholder.com/800x200";
  document.getElementById("profilePhoto").src = (fields.Imagen && fields.Imagen[0]) ? fields.Imagen[0].url : "https://via.placeholder.com/100";
  document.getElementById("cloneName").innerText = fields.Nombre || "Sin nombre";
  document.getElementById("chatCloneName").innerText = fields.Nombre || "Sin nombre";
  document.getElementById("cloneDescription").innerText = fields.Descripcion || "Sin descripciÃ³n";
  document.getElementById("galleryTitle").innerText = fields.Nombre || "Sin nombre";
  
  // Extraer el cÃ³digo de voz asignado
  window.elevenVoiceId = fields.ELEVENLABS_VOICE_ID || "default_voice_id";
  console.log("Voice ID:", window.elevenVoiceId);
}

      async function sendMessage() {
  const input = document.getElementById("chatInput");
  const messageText = input.value.trim();
  if (!messageText) return;
  
  const chatBox = document.getElementById("chatBox");
  const userMsg = document.createElement('div');
  userMsg.classList.add('chat-message', 'user-message');
  userMsg.textContent = messageText;
  chatBox.appendChild(userMsg);
  chatBox.scrollTop = chatBox.scrollHeight;
  
  document.getElementById("sendSound").play();
  input.value = "";
  
  const typingIndicator = document.getElementById("typingIndicator");
  typingIndicator.style.display = "block";
  typingIndicator.innerText = document.getElementById("chatCloneName").innerText + " estÃ¡ escribiendo...";
  
  let initialDelay = Math.floor(Math.random() * 1500) + 1500;
  await new Promise(resolve => setTimeout(resolve, initialDelay));
  
  try {
    const response = await fetch(apiUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `ActÃºa como si tu nombre fuera "${document.getElementById("chatCloneName").innerText}" y tu descripciÃ³n es: "${document.getElementById("cloneDescription").innerText}". 
            Responde siempre en primera persona y evita mencionar que eres un modelo de lenguaje. 
            El usuario dice: "${messageText}".`
          }]
        }]
      })
    });
    const responseData = await response.json();
    
    let additionalDelay = Math.floor(Math.random() * 2000) + 2000;
    await new Promise(resolve => setTimeout(resolve, additionalDelay));
    
    let botText = "";
    if (!response.ok || !responseData.candidates) {
      botText = "No se pudo obtener respuesta.";
    } else {
      botText = responseData.candidates[0].content.parts[0].text;
    }
    
    const botMsg = document.createElement('div');
    botMsg.classList.add('chat-message', 'bot-message');
    botMsg.textContent = botText;
    chatBox.appendChild(botMsg);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // Reproduce solo el sonido de notificaciÃ³n
    document.getElementById("receiveSound").play();
    
    // Si hay una llamada activa (se detecta un "callMessage"), guarda la respuesta para que llamada.html la reproduzca
    if (localStorage.getItem("callMessage")) {
      localStorage.setItem('callResponse', JSON.stringify({ text: botText, timestamp: Date.now() }));
    }
    
    // Comentamos la reproducciÃ³n de audio TTS para el chat:
    // speak(botText);
    // document.getElementById("receiveSound").play();
    
  } catch (error) {
    const errorMsg = document.createElement('div');
    errorMsg.classList.add('chat-message', 'bot-message');
    errorMsg.style.color = "red";
    errorMsg.textContent = error.message; // Muestra el error para depuraciÃ³n
    chatBox.appendChild(errorMsg);
    chatBox.scrollTop = chatBox.scrollHeight;
  } finally {
    typingIndicator.style.display = "none";
  }
}

async function getCloneResponse(userText) {
  try {
    const response = await fetch(apiUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `ActÃºa como si tu nombre fuera "${document.getElementById("chatCloneName").innerText}" y tu descripciÃ³n es: "${document.getElementById("cloneDescription").innerText}". Responde siempre en primera persona y evita mencionar que eres un modelo de lenguaje. El usuario dice: "${userText}".`
          }]
        }]
      })
    });

    const responseData = await response.json();
    let botText;

    if (!response.ok || !responseData.candidates) {
      botText = "No se pudo obtener respuesta.";
    } else {
      botText = responseData.candidates[0].content.parts[0].text;
    }

    // Almacena automÃ¡ticamente la respuesta en localStorage
    localStorage.setItem('callResponse', JSON.stringify({ text: botText, timestamp: Date.now() }));

    return botText;

  } catch (error) {
    const errorText = "Error al conectar con el clon.";
    localStorage.setItem('callResponse', JSON.stringify({ text: errorText, timestamp: Date.now() }));
    return errorText;
  }
}
      function sendPhoto(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageUrl = e.target.result;
          const chatBox = document.getElementById("chatBox");
          const imageMessage = document.createElement("div");
          imageMessage.classList.add('chat-message', 'user-message');
          const img = document.createElement("img");
          img.src = imageUrl;
          img.style.maxWidth = "100%";
          img.style.borderRadius = "10px";
          imageMessage.appendChild(img);
          chatBox.appendChild(imageMessage);
          chatBox.scrollTop = chatBox.scrollHeight;
        };
        reader.readAsDataURL(file);
      }
      
      async function uploadImage(file) {
        try {
          const formData = new FormData();
          formData.append('photo', file);
          const response = await fetch('https://tu-servidor.com/subir-imagen', {
            method: 'POST',
            body: formData
          });
          if (!response.ok) {
            throw new Error('Error al subir la imagen.');
          }
          const data = await response.json();
          return data.imageUrl;
        } catch (error) {
          console.error('Error en uploadImage:', error);
          throw error;
        }
      }
      
      async function analyzeImage(imageUrl) {
        try {
          const response = await fetch('https://tu-servidor.com/analizar-imagen', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imageUrl })
          });
          if (!response.ok) {
            throw new Error('Error al analizar la imagen.');
          }
          const data = await response.json();
          return data.description || "No se pudo obtener una descripciÃ³n.";
        } catch (error) {
          console.error('Error en analyzeImage:', error);
          return "Error al analizar la imagen.";
        }
      }
      
      async function sendPhotoMessage(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
          const imageUrlLocal = e.target.result;
          const chatBox = document.getElementById("chatBox");
          const imageMessage = document.createElement("div");
          imageMessage.classList.add('chat-message', 'user-message');
          const img = document.createElement("img");
          img.src = imageUrlLocal;
          img.style.maxWidth = "100%";
          img.style.borderRadius = "10px";
          imageMessage.appendChild(img);
          chatBox.appendChild(imageMessage);
          chatBox.scrollTop = chatBox.scrollHeight;
          
          try {
            const uploadedImageUrl = await uploadImage(file);
            const description = await analyzeImage(uploadedImageUrl);
            const prompt = `Te he enviado una imagen que parece mostrar: "${description}". Â¿QuÃ© opinas?`;
            await sendMessageToClone(prompt);
          } catch (error) {
            console.error("Error al procesar el mensaje de imagen:", error);
          }
        };
        reader.readAsDataURL(file);
      }
      
      async function sendMessageToClone(messageText) {
        try {
          const botResponse = await getCloneResponse(messageText);
          const chatBox = document.getElementById("chatBox");
          const botMsg = document.createElement("div");
          botMsg.classList.add("chat-message", "bot-message");
          botMsg.textContent = botResponse;
          chatBox.appendChild(botMsg);
          chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
          console.error("Error en sendMessageToClone:", error);
        }
      }
      
      async function showTypingStatus() {
        const chatInput = document.getElementById("chatInput");
        if(chatInput.value.trim() !== "") {
          const typingIndicator = document.getElementById("typingIndicator");
          typingIndicator.style.display = "block";
          typingIndicator.innerText = document.getElementById("chatCloneName").innerText + " estÃ¡ escribiendo...";
        } else {
          document.getElementById("typingIndicator").style.display = "none";
        }
      }
      
      async function goBack() {
        window.history.back();
      }
      // NUEVO: Escucha cambios en localStorage para mensajes de llamada
      window.addEventListener('storage', function(event) {
        if (event.key === 'callMessage' && event.newValue) {
          const messageData = JSON.parse(event.newValue);
          processCallMessage(messageData);
        }
      });
      
      // Procesa el mensaje recibido de llamada (por ejemplo, voz convertida a texto)
      async function processCallMessage(messageData) {
        const messageText = messageData.text;
        console.log("Mensaje de llamada recibido: " + messageText);
        // ObtÃ©n la respuesta del clon usando la funciÃ³n existente
        const botResponse = await getCloneResponse(messageText);
        // Guarda la respuesta en localStorage para que llamada.html la recoja
        localStorage.setItem('callResponse', JSON.stringify({ text: botResponse, timestamp: Date.now() }));
      }
      window.addEventListener("message", function(event) {
    if (event.data.type === "callMessage") {
        const messageText = event.data.text;

        // Mostrar el mensaje en el chat como si fuera escrito
        const chatBox = document.getElementById("chatBox");
        const userMsg = document.createElement('div');
        userMsg.classList.add('chat-message', 'user-message');
        userMsg.textContent = messageText;
        chatBox.appendChild(userMsg);
        chatBox.scrollTop = chatBox.scrollHeight;

        // Enviar el mensaje al bot
        getCloneResponse(messageText).then(botResponse => {
            // Mostrar la respuesta en el chat
            const botMsg = document.createElement('div');
            botMsg.classList.add('chat-message', 'bot-message');
            botMsg.textContent = botResponse;
            chatBox.appendChild(botMsg);
            chatBox.scrollTop = chatBox.scrollHeight;

            // Guardar la respuesta para la llamada
            localStorage.setItem('callResponse', JSON.stringify({ text: botResponse, timestamp: Date.now() }));
        });
    }
});

    </script>
    <!-- Agrega estos elementos al final del body -->
    <audio id="sendSound" src="https://www.myinstants.com/media/sounds/message-sent.mp3" preload="auto"></audio>
    <audio id="receiveSound" src="https://www.myinstants.com/media/sounds/message-received.mp3" preload="auto"></audio>
  </div>
</body>
</html>
